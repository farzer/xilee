<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>XiLee DOS</title>
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
</head>
<body>
<div class="container flex flex-row w-screen max-w-full p-3">
    <div class="w-6/12">
        <iframe src='https://view.officeapps.live.com/op/view.aspx?src=http://localhost:63342/xilee/tpl/receipts_tpl.docx' width='1366px' height='623px' frameborder='0'>This is an embedded
            <a target='_blank' href='http://office.com'>Microsoft Office</a> document, powered by
            <a target='_blank' href='http://office.com/webapps'>Office Online</a>.
        </iframe>
        <span>使用默认模板</span>
    </div>
    <div class="w-6/12">
        <span>输出</span>
    </div>
</div>
<button onclick="generate()">Generate document</button>
</body>
<script src="https://unpkg.com/vue@2.6.12/dist/vue.js"></script>
<script src="https://unpkg.com/xlsx@0.16.9/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.19.7/docxtemplater.js"></script>
<script src="https://unpkg.com/pizzip@3.0.6/dist/pizzip.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>
<script src="https://unpkg.com/pizzip@3.0.6/dist/pizzip-utils.js"></script>
<!--
Mandatory in IE 6, 7, 8 and 9.
-->
<!--[if IE]>
<script type="text/javascript" src="https://unpkg.com/pizzip@3.0.6/dist/pizzip-utils-ie.js"></script>
<![endif]-->
<script>
  function loadFile(url,callback){
    PizZipUtils.getBinaryContent(url,callback);
  }
  function generate() {
    loadFile("./tpl/receipts_tpl.docx",function(error,content){
      if (error) { throw error }

      // The error object contains additional information when logged with JSON.stringify (it contains a properties object containing all suberrors).
      function replaceErrors(key, value) {
        if (value instanceof Error) {
          return Object.getOwnPropertyNames(value).reduce(function(error, key) {
            error[key] = value[key];
            return error;
          }, {});
        }
        return value;
      }

      function errorHandler(error) {
        console.log(JSON.stringify({error: error}, replaceErrors));

        if (error.properties && error.properties.errors instanceof Array) {
          const errorMessages = error.properties.errors.map(function (error) {
            return error.properties.explanation;
          }).join("\n");
          console.log('errorMessages', errorMessages);
          // errorMessages is a humanly readable message looking like this :
          // 'The tag beginning with "foobar" is unopened'
        }
        throw error;
      }

      var zip = new PizZip(content);
      var doc;
      try {
        doc=new window.docxtemplater(zip);
      } catch(error) {
        // Catch compilation errors (errors caused by the compilation of the template : misplaced tags)
        errorHandler(error);
      }

      doc.setData({
          receipts: [
              {
                  project: '深圳市大邦实业有限公司结算单',
                  title: '测试标题',
                  amount: '200.00',
                  amountCN: '贰佰',
                  y: '2021',
                  m: '1',
                  d: '21'
              },
              {
                  project: '深圳市大邦实业有限公司结算单',
                  title: '测试标题',
                  amount: '20000.00',
                  amountCN: '贰万',
                  y: '2020',
                  m: '2',
                  d: '1'
              },
              {
                  project: '深圳市大邦实业有限公司结算单',
                  title: '测试标题',
                  amount: '200.00',
                  amountCN: '贰佰',
                  y: '2021',
                  m: '1',
                  d: '21'
              },
              {
                  project: '深圳市大邦实业有限公司结算单',
                  title: '测试标题',
                  amount: '20000.00',
                  amountCN: '贰万',
                  y: '2020',
                  m: '2',
                  d: '1'
              },
              {
                  project: '深圳市大邦实业有限公司结算单',
                  title: '测试标题',
                  amount: '200.00',
                  amountCN: '贰佰',
                  y: '2021',
                  m: '1',
                  d: '21'
              },
              {
                  project: '深圳市大邦实业有限公司结算单',
                  title: '测试标题',
                  amount: '20000.00',
                  amountCN: '贰万',
                  y: '2020',
                  m: '2',
                  d: '1'
              }
          ]
      });
      try {
        // render the document (replace all occurences of {first_name} by John, {last_name} by Doe, ...)
        doc.render();
      }
      catch (error) {
        // Catch rendering errors (errors relating to the rendering of the template : angularParser throws an error)
        errorHandler(error);
      }

      var out=doc.getZip().generate({
        type:"blob",
        mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
      }) //Output the document using Data-URI
      saveAs(out,"output.docx")
    })
  }
</script>
</html>
